<!DOCTYPE html>
<html>

		<head>
				<title>stupid file host</title>
				<link rel="stylesheet" href="styles.css">
		</head>

	<body>

		<div class="container">
			<div class="content">
				<h1>your stupid dashboard</h1>
				<input type="file" id="fileInput">
				<button id="upload" type="button" onclick="upload()">Upload stupid attachment</button>
				<ul id="files">
				</ul>
			</div>
		</div>
	
	</body>
	
</html>

<script>
	function getCookie(name) {
		var match = document.cookie.match(RegExp('(?:^|;\\s*)' + name + '=([^;]*)'));
		return match ? match[1] : null;
	}
	const token = getCookie("token");
	if (token == null) {
		window.location = '/';
	}
	window.upload = async () => {
		const fileInput = document.getElementById("fileInput");
		if (fileInput.files.length === 0) {
			alert('Select a file duh!');
			return;
		}
		const formData = new FormData();
		formData.append('file', fileInput.files[0]);
		await fetch('/upload', {
			method: 'POST',
			headers: {
				'token': token
			},
			body: formData
		}).then(async resp => {
			const data = await resp.json();
			if (!resp.ok) {
				alert('papu hubo un error jajasdjas consola');
				console.log(data);
				return;
			}
			alert('File uploaded! file id:' + data.id);
			const ul = document.getElementById("files");
			let id = data.id;
			let li = document.createElement("li");
			li.id = `item-${id}`;
			let a = document.createElement("a");
			a.href = `/file/${id}`
			a.textContent = fileInput.files[0].name;
			li.appendChild(a);
			let btn = document.createElement("button");
			btn.textContent = "Delete";
			btn.onclick = async () => await deleteFile(id);
			li.appendChild(btn);
			ul.appendChild(li);
		}).catch(err => {
			console.log(err)
		});
	}
	document.addEventListener("DOMContentLoaded", async () => {
		await fetch('/files', {
			method: 'GET',
			headers: {
				'token': token
			}
		}).then(async resp => {
			const data = await resp.json();
			if (!resp.ok) {
				alert("Could not fetch files, check console");
				console.log(data);
				return;
			}
			const ul = document.getElementById("files");
			for (let i = 0; i < data.ids.length; i++) {
			    let id = data.ids[i];
			    let li = document.createElement("li");
				li.id = `item-${id}`;
			    let a = document.createElement("a");
			    a.href = `/file/${id}`
			    a.textContent = data.filenames[i];
			    li.appendChild(a);
			    let btn = document.createElement("button");
			    btn.textContent = "Delete";
			    btn.onclick = async () => await deleteFile(id);
			    li.appendChild(btn);
			    ul.appendChild(li);
			}
		}).catch(err => {
			console.log(err);
		});
	});
	async function deleteFile(id) {
	    await fetch(`/delete?id=${id}`, {
	        method: 'POST',
	        headers: {
	            'token': token
	        }
	    }).then(async resp => {
	        if (!resp.ok) {
	            const data = await resp.json();
	            alert("Could not delete file, check console");
	            console.log(data);
	            return;
	        }
	        let li = document.getElementById(`item-${id}`);
	        li.remove();
	        alert(`File ${id} removed!`);
	    }).catch(err => {
	        console.log(err);
	    });
	}
</script>
